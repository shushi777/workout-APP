---
phase: 04-exercise-library
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/api.ts
  - frontend/src/stores/exerciseStore.ts
  - frontend/src/components/library/ExerciseCard.tsx
  - frontend/src/components/library/ExerciseGrid.tsx
  - frontend/src/components/library/SearchFilters.tsx
  - frontend/src/pages/LibraryPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can view all saved exercises in a responsive grid"
    - "User can type in search box and see filtered exercises by name"
    - "User can tap muscle group chips to filter by muscle"
    - "User can tap equipment chips to filter by equipment"
  artifacts:
    - path: "frontend/src/lib/api.ts"
      provides: "fetchExercises API function"
      contains: "fetchExercises"
    - path: "frontend/src/stores/exerciseStore.ts"
      provides: "Exercise state management"
      exports: ["useExerciseStore"]
    - path: "frontend/src/components/library/ExerciseCard.tsx"
      provides: "Individual exercise card component"
      exports: ["ExerciseCard"]
    - path: "frontend/src/components/library/ExerciseGrid.tsx"
      provides: "Grid layout for exercise cards"
      exports: ["ExerciseGrid"]
    - path: "frontend/src/components/library/SearchFilters.tsx"
      provides: "Search input and filter chips"
      exports: ["SearchFilters"]
    - path: "frontend/src/pages/LibraryPage.tsx"
      provides: "Main library page"
      min_lines: 50
  key_links:
    - from: "frontend/src/pages/LibraryPage.tsx"
      to: "useExerciseStore"
      via: "import and hook usage"
      pattern: "useExerciseStore"
    - from: "frontend/src/stores/exerciseStore.ts"
      to: "fetchExercises"
      via: "API call in fetchExercises action"
      pattern: "fetchExercises"
---

<objective>
Build exercise library grid with search and filter functionality.

Purpose: Enable users to browse, search, and filter their saved exercises in a responsive grid layout (LIB-01, LIB-02, LIB-03, LIB-04).

Output: Exercise library page with grid of cards, search input, and filter chips for muscle groups and equipment.
</objective>

<execution_context>
@C:\Users\OmriS\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\OmriS\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-exercise-library/04-RESEARCH.md

Reference existing patterns:
@frontend/src/stores/uploadStore.ts (Zustand store pattern)
@frontend/src/stores/timelineStore.ts (Complex store with async actions)
@frontend/src/lib/api.ts (API function patterns)
@frontend/src/components/tagging/AutocompleteChips.tsx (Chip component pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exercise API functions and types</name>
  <files>frontend/src/lib/api.ts</files>
  <action>
Add to frontend/src/lib/api.ts:

1. Add Exercise interface:
```typescript
export interface Exercise {
  id: number;
  exercise_name: string;
  duration: number;
  video_url: string;
  thumbnail_url: string | null;
  muscle_groups: string[];
  equipment: string[];
  created_at: string;
  start_time: number;
  end_time: number;
  remove_audio: boolean;
}
```

2. Add ExercisesResponse interface:
```typescript
export interface ExercisesResponse {
  success: boolean;
  exercises: Exercise[];
  muscle_groups: string[];
  equipment: string[];
  pagination: {
    page: number;
    per_page: number;
    total_count: number;
    total_pages: number;
    has_next: boolean;
    has_prev: boolean;
  };
}
```

3. Add fetchExercises function:
```typescript
export async function fetchExercises(params?: {
  page?: number;
  per_page?: number;
  search?: string;
  muscle_groups?: string[];
  equipment?: string[];
}): Promise<ExercisesResponse> {
  const query = new URLSearchParams();
  if (params?.page) query.append('page', params.page.toString());
  if (params?.per_page) query.append('per_page', params.per_page.toString());
  if (params?.search) query.append('search', params.search);
  if (params?.muscle_groups?.length) query.append('muscle_groups', params.muscle_groups.join(','));
  if (params?.equipment?.length) query.append('equipment', params.equipment.join(','));

  const response = await fetch(`/api/exercises?${query.toString()}`);
  if (!response.ok) {
    throw new Error('Failed to fetch exercises');
  }
  return response.json();
}
```

4. Add updateExercise function:
```typescript
export interface UpdateExerciseData {
  exercise_name?: string;
  muscle_groups?: string[];
  equipment?: string[];
}

export async function updateExercise(id: number, data: UpdateExerciseData): Promise<{ success: boolean }> {
  const response = await fetch(`/api/exercises/${id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  });
  if (!response.ok) {
    throw new Error('Failed to update exercise');
  }
  return response.json();
}
```

5. Add deleteExercise function:
```typescript
export async function deleteExercise(id: number): Promise<{ success: boolean }> {
  const response = await fetch(`/api/exercises/${id}`, {
    method: 'DELETE',
  });
  if (!response.ok) {
    throw new Error('Failed to delete exercise');
  }
  return response.json();
}
```
  </action>
  <verify>TypeScript compiles without errors: `cd frontend && npx tsc --noEmit`</verify>
  <done>Exercise API types and functions added to api.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create exercise store with search/filter state</name>
  <files>frontend/src/stores/exerciseStore.ts</files>
  <action>
Create frontend/src/stores/exerciseStore.ts following the Zustand pattern from uploadStore.ts:

```typescript
import { create } from 'zustand';
import { fetchExercises, updateExercise, deleteExercise, type Exercise } from '@/lib/api';

interface ExerciseState {
  // Data
  exercises: Exercise[];
  allMuscleGroups: string[];
  allEquipment: string[];

  // Filters
  searchTerm: string;
  selectedMuscles: Set<string>;
  selectedEquipment: Set<string>;

  // Loading state
  isLoading: boolean;
  error: string | null;

  // Actions
  fetchExercises: () => Promise<void>;
  setSearchTerm: (term: string) => void;
  toggleMuscleFilter: (muscle: string) => void;
  toggleEquipmentFilter: (equipment: string) => void;
  clearFilters: () => void;
  updateExercise: (id: number, data: { exercise_name?: string; muscle_groups?: string[]; equipment?: string[] }) => Promise<void>;
  deleteExercise: (id: number) => Promise<void>;
}

export const useExerciseStore = create<ExerciseState>()((set, get) => ({
  // Initial state
  exercises: [],
  allMuscleGroups: [],
  allEquipment: [],
  searchTerm: '',
  selectedMuscles: new Set<string>(),
  selectedEquipment: new Set<string>(),
  isLoading: false,
  error: null,

  fetchExercises: async () => {
    set({ isLoading: true, error: null });
    try {
      // Load all exercises (client-side filtering per research)
      const response = await fetchExercises({ per_page: 100 });
      set({
        exercises: response.exercises,
        allMuscleGroups: response.muscle_groups,
        allEquipment: response.equipment,
        isLoading: false,
      });
    } catch (error) {
      set({ error: 'Failed to load exercises', isLoading: false });
    }
  },

  setSearchTerm: (term) => set({ searchTerm: term }),

  toggleMuscleFilter: (muscle) => {
    const muscles = new Set(get().selectedMuscles);
    if (muscles.has(muscle)) {
      muscles.delete(muscle);
    } else {
      muscles.add(muscle);
    }
    set({ selectedMuscles: muscles });
  },

  toggleEquipmentFilter: (equipment) => {
    const equip = new Set(get().selectedEquipment);
    if (equip.has(equipment)) {
      equip.delete(equipment);
    } else {
      equip.add(equipment);
    }
    set({ selectedEquipment: equip });
  },

  clearFilters: () => set({
    searchTerm: '',
    selectedMuscles: new Set<string>(),
    selectedEquipment: new Set<string>(),
  }),

  updateExercise: async (id, data) => {
    try {
      await updateExercise(id, data);
      // Refresh list after update
      await get().fetchExercises();
    } catch (error) {
      throw error;
    }
  },

  deleteExercise: async (id) => {
    try {
      await deleteExercise(id);
      // Remove from local state
      set((state) => ({
        exercises: state.exercises.filter((ex) => ex.id !== id),
      }));
    } catch (error) {
      throw error;
    }
  },
}));
```
  </action>
  <verify>TypeScript compiles: `cd frontend && npx tsc --noEmit`</verify>
  <done>Exercise store created with filter state and CRUD actions</done>
</task>

<task type="auto">
  <name>Task 3: Create library components and wire up LibraryPage</name>
  <files>
    frontend/src/components/library/ExerciseCard.tsx
    frontend/src/components/library/ExerciseGrid.tsx
    frontend/src/components/library/SearchFilters.tsx
    frontend/src/pages/LibraryPage.tsx
  </files>
  <action>
1. Create frontend/src/components/library/ExerciseCard.tsx:
```typescript
import { type Exercise } from '@/lib/api';
import { Edit2, Trash2 } from 'lucide-react';

interface ExerciseCardProps {
  exercise: Exercise;
  onEdit: (exercise: Exercise) => void;
  onDelete: (exercise: Exercise) => void;
}

function formatDuration(seconds: number): string {
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

export function ExerciseCard({ exercise, onEdit, onDelete }: ExerciseCardProps) {
  return (
    <div className="bg-gray-900 rounded-xl overflow-hidden shadow-md hover:shadow-lg transition-all">
      {/* Thumbnail/Video Container */}
      <div className="relative aspect-video bg-gray-800">
        {exercise.thumbnail_url ? (
          <img
            src={exercise.thumbnail_url}
            alt={exercise.exercise_name}
            className="w-full h-full object-cover"
          />
        ) : (
          <div className="w-full h-full flex items-center justify-center text-gray-600">
            <span className="text-4xl"></span>
          </div>
        )}
        {/* Play overlay - video playback added in plan 02 */}
        <div className="absolute inset-0 flex items-center justify-center bg-black/30 opacity-0 hover:opacity-100 transition-opacity cursor-pointer">
          <span className="text-5xl">讹</span>
        </div>
      </div>

      {/* Card Info */}
      <div className="p-4">
        <div className="flex justify-between items-start mb-2">
          <h3 className="text-lg font-bold text-white">{exercise.exercise_name}</h3>
          <div className="flex gap-2">
            <button
              onClick={() => onEdit(exercise)}
              className="p-2 text-blue-400 hover:text-blue-300 hover:bg-gray-800 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center"
              aria-label="注专 转专"
            >
              <Edit2 className="w-5 h-5" />
            </button>
            <button
              onClick={() => onDelete(exercise)}
              className="p-2 text-red-400 hover:text-red-300 hover:bg-gray-800 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center"
              aria-label="拽 转专"
            >
              <Trash2 className="w-5 h-5" />
            </button>
          </div>
        </div>

        <div className="text-sm text-gray-400 mb-3">
          憋 {formatDuration(exercise.duration)}
        </div>

        {/* Tags */}
        <div className="flex flex-wrap gap-2">
          {exercise.muscle_groups?.map((mg) => (
            <span
              key={mg}
              className="px-2 py-1 bg-blue-900/50 text-blue-300 rounded-full text-xs"
            >
              {mg}
            </span>
          ))}
          {exercise.equipment?.map((eq) => (
            <span
              key={eq}
              className="px-2 py-1 bg-yellow-900/50 text-yellow-300 rounded-full text-xs"
            >
              {eq}
            </span>
          ))}
        </div>
      </div>
    </div>
  );
}
```

2. Create frontend/src/components/library/ExerciseGrid.tsx:
```typescript
import { type Exercise } from '@/lib/api';
import { ExerciseCard } from './ExerciseCard';

interface ExerciseGridProps {
  exercises: Exercise[];
  onEdit: (exercise: Exercise) => void;
  onDelete: (exercise: Exercise) => void;
}

export function ExerciseGrid({ exercises, onEdit, onDelete }: ExerciseGridProps) {
  if (exercises.length === 0) {
    return (
      <div className="bg-gray-900 rounded-xl p-8 text-center">
        <p className="text-gray-500 text-lg"> 爪 转专</p>
        <p className="text-gray-600 text-sm mt-2">住 砖转 转 驻砖  住</p>
      </div>
    );
  }

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
      {exercises.map((exercise) => (
        <ExerciseCard
          key={exercise.id}
          exercise={exercise}
          onEdit={onEdit}
          onDelete={onDelete}
        />
      ))}
    </div>
  );
}
```

3. Create frontend/src/components/library/SearchFilters.tsx:
```typescript
import { Search, X } from 'lucide-react';
import { cn } from '@/lib/utils';

interface SearchFiltersProps {
  searchTerm: string;
  onSearchChange: (term: string) => void;
  muscleGroups: string[];
  selectedMuscles: Set<string>;
  onToggleMuscle: (muscle: string) => void;
  equipment: string[];
  selectedEquipment: Set<string>;
  onToggleEquipment: (equipment: string) => void;
  onClearFilters: () => void;
}

export function SearchFilters({
  searchTerm,
  onSearchChange,
  muscleGroups,
  selectedMuscles,
  onToggleMuscle,
  equipment,
  selectedEquipment,
  onToggleEquipment,
  onClearFilters,
}: SearchFiltersProps) {
  const hasFilters = searchTerm || selectedMuscles.size > 0 || selectedEquipment.size > 0;

  return (
    <div className="space-y-4">
      {/* Search Input */}
      <div className="relative">
        <Search className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" />
        <input
          type="text"
          value={searchTerm}
          onChange={(e) => onSearchChange(e.target.value)}
          placeholder="驻砖 转专..."
          className="w-full bg-gray-800 border border-gray-700 rounded-lg pr-10 pl-4 py-3 text-white
                     placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500
                     min-h-[44px]"
          dir="rtl"
        />
      </div>

      {/* Muscle Groups Filter */}
      {muscleGroups.length > 0 && (
        <div>
          <label className="block text-sm text-gray-400 mb-2">拽爪转 砖专专</label>
          <div className="flex flex-wrap gap-2">
            {muscleGroups.map((muscle) => (
              <button
                key={muscle}
                onClick={() => onToggleMuscle(muscle)}
                className={cn(
                  'px-3 py-1.5 rounded-full text-sm transition-colors min-h-[36px]',
                  selectedMuscles.has(muscle)
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                )}
              >
                {muscle}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Equipment Filter */}
      {equipment.length > 0 && (
        <div>
          <label className="block text-sm text-gray-400 mb-2">爪</label>
          <div className="flex flex-wrap gap-2">
            {equipment.map((equip) => (
              <button
                key={equip}
                onClick={() => onToggleEquipment(equip)}
                className={cn(
                  'px-3 py-1.5 rounded-full text-sm transition-colors min-h-[36px]',
                  selectedEquipment.has(equip)
                    ? 'bg-yellow-600 text-white'
                    : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                )}
              >
                {equip}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* Clear Filters */}
      {hasFilters && (
        <button
          onClick={onClearFilters}
          className="flex items-center gap-2 text-sm text-gray-400 hover:text-white transition-colors"
        >
          <X className="w-4 h-4" />
          拽 住
        </button>
      )}
    </div>
  );
}
```

4. Update frontend/src/pages/LibraryPage.tsx:
```typescript
import { useEffect, useMemo, useDeferredValue } from 'react';
import { useExerciseStore } from '@/stores/exerciseStore';
import { ExerciseGrid } from '@/components/library/ExerciseGrid';
import { SearchFilters } from '@/components/library/SearchFilters';
import { type Exercise } from '@/lib/api';

export function LibraryPage() {
  const {
    exercises,
    allMuscleGroups,
    allEquipment,
    searchTerm,
    selectedMuscles,
    selectedEquipment,
    isLoading,
    error,
    fetchExercises,
    setSearchTerm,
    toggleMuscleFilter,
    toggleEquipmentFilter,
    clearFilters,
  } = useExerciseStore();

  // Load exercises on mount
  useEffect(() => {
    fetchExercises();
  }, [fetchExercises]);

  // Defer search/filter to avoid blocking input (per research)
  const deferredSearch = useDeferredValue(searchTerm);
  const deferredMuscles = useDeferredValue(selectedMuscles);
  const deferredEquipment = useDeferredValue(selectedEquipment);

  // Filter exercises client-side (per research recommendation)
  const filteredExercises = useMemo(() => {
    return exercises.filter((ex) => {
      // Search filter
      const nameMatch =
        deferredSearch === '' ||
        ex.exercise_name.toLowerCase().includes(deferredSearch.toLowerCase());

      // Muscle groups filter
      const muscleMatch =
        deferredMuscles.size === 0 ||
        (ex.muscle_groups && ex.muscle_groups.some((mg) => deferredMuscles.has(mg)));

      // Equipment filter
      const equipmentMatch =
        deferredEquipment.size === 0 ||
        (ex.equipment && ex.equipment.some((eq) => deferredEquipment.has(eq)));

      return nameMatch && muscleMatch && equipmentMatch;
    });
  }, [exercises, deferredSearch, deferredMuscles, deferredEquipment]);

  // TODO: Implement in Plan 02
  const handleEdit = (exercise: Exercise) => {
    console.log('Edit exercise:', exercise.id);
  };

  const handleDelete = (exercise: Exercise) => {
    console.log('Delete exercise:', exercise.id);
  };

  if (error) {
    return (
      <div className="p-4">
        <div className="bg-red-900/50 text-red-300 rounded-lg p-4 text-center">
          {error}
        </div>
      </div>
    );
  }

  return (
    <div className="p-4 pb-24">
      <h1 className="text-2xl font-bold mb-4 text-white">住驻专转 转专</h1>

      {/* Search and Filters */}
      <div className="mb-6">
        <SearchFilters
          searchTerm={searchTerm}
          onSearchChange={setSearchTerm}
          muscleGroups={allMuscleGroups}
          selectedMuscles={selectedMuscles}
          onToggleMuscle={toggleMuscleFilter}
          equipment={allEquipment}
          selectedEquipment={selectedEquipment}
          onToggleEquipment={toggleEquipmentFilter}
          onClearFilters={clearFilters}
        />
      </div>

      {/* Results count */}
      <p className="text-gray-400 text-sm mb-4">
        {isLoading ? '注...' : `${filteredExercises.length} 转专`}
      </p>

      {/* Exercise Grid */}
      {isLoading ? (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          {[1, 2, 3, 4].map((i) => (
            <div key={i} className="bg-gray-900 rounded-xl overflow-hidden animate-pulse">
              <div className="aspect-video bg-gray-800" />
              <div className="p-4 space-y-3">
                <div className="h-6 bg-gray-800 rounded w-3/4" />
                <div className="h-4 bg-gray-800 rounded w-1/4" />
                <div className="flex gap-2">
                  <div className="h-6 bg-gray-800 rounded-full w-16" />
                  <div className="h-6 bg-gray-800 rounded-full w-20" />
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <ExerciseGrid
          exercises={filteredExercises}
          onEdit={handleEdit}
          onDelete={handleDelete}
        />
      )}
    </div>
  );
}
```
  </action>
  <verify>
1. TypeScript compiles: `cd frontend && npx tsc --noEmit`
2. Run dev server and navigate to Library tab
3. Verify exercises load from backend
4. Verify search filters exercises by name
5. Verify muscle group chips filter exercises
6. Verify equipment chips filter exercises
  </verify>
  <done>Library page displays exercise grid with working search and filter functionality</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Exercise library loads and displays exercises from backend
3. Search input filters exercises by name (with deferred value for smooth typing)
4. Muscle group chips toggle and filter exercises
5. Equipment chips toggle and filter exercises
6. Clear filters button resets all filters
7. Empty state shows when no exercises match filters
8. Loading skeletons appear while fetching
9. Grid is responsive (1 col mobile, 2 tablet, 3 laptop, 4 desktop)
</verification>

<success_criteria>
- LIB-01: User can view all saved exercises in grid layout
- LIB-02: User can search exercises by name
- LIB-03: User can filter exercises by muscle groups
- LIB-04: User can filter exercises by equipment
- TypeScript compiles without errors
- UI follows existing dark theme and 44px touch targets
</success_criteria>

<output>
After completion, create `.planning/phases/04-exercise-library/04-01-SUMMARY.md`
</output>
