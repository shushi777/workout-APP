---
phase: 02-upload-feature
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/api.ts
  - frontend/src/stores/uploadStore.ts
  - frontend/src/components/ui/ProgressBar.tsx
  - frontend/src/components/upload/DropZone.tsx
  - frontend/src/pages/UploadPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can drag-and-drop a video file onto the upload area"
    - "User can tap to select a video file from device storage"
    - "User sees upload progress bar while video transfers"
    - "User sees processing status while scene detection runs"
    - "User is automatically navigated to Editor tab after processing completes"
  artifacts:
    - path: "frontend/src/lib/api.ts"
      provides: "XHR upload function with progress tracking"
      exports: ["uploadVideoWithProgress", "ProcessResponse", "UploadProgress"]
    - path: "frontend/src/stores/uploadStore.ts"
      provides: "Upload state management"
      exports: ["useUploadStore"]
    - path: "frontend/src/components/ui/ProgressBar.tsx"
      provides: "Reusable progress bar component"
      exports: ["ProgressBar"]
    - path: "frontend/src/components/upload/DropZone.tsx"
      provides: "Drag-and-drop file selection"
      exports: ["DropZone"]
    - path: "frontend/src/pages/UploadPage.tsx"
      provides: "Complete upload flow with navigation"
      contains: "useNavigate"
  key_links:
    - from: "frontend/src/pages/UploadPage.tsx"
      to: "frontend/src/stores/uploadStore.ts"
      via: "useUploadStore hook"
      pattern: "useUploadStore\\(\\)"
    - from: "frontend/src/pages/UploadPage.tsx"
      to: "frontend/src/lib/api.ts"
      via: "uploadVideoWithProgress function"
      pattern: "uploadVideoWithProgress"
    - from: "frontend/src/pages/UploadPage.tsx"
      to: "/editor"
      via: "useNavigate on complete"
      pattern: "navigate\\(.*/editor"
---

<objective>
Implement video upload with drag-and-drop, progress tracking, and automatic navigation to Editor.

Purpose: Enable users to upload workout videos with visual feedback and seamless transition to editing.
Output: Working upload flow with DropZone, progress bar, processing status, and Editor navigation.
</objective>

<execution_context>
@C:\Users\OmriS\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\OmriS\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-upload-feature/02-RESEARCH.md

Phase 1 established:
- cn() utility at frontend/src/lib/utils.ts
- Button component at frontend/src/components/ui/Button.tsx
- React Router with useNavigate available
- Zustand pattern with uiStore.ts
- UploadPage placeholder ready to replace
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create upload infrastructure (api, store, ProgressBar)</name>
  <files>
    frontend/src/lib/api.ts
    frontend/src/stores/uploadStore.ts
    frontend/src/components/ui/ProgressBar.tsx
  </files>
  <action>
Create three files for upload infrastructure:

**1. frontend/src/lib/api.ts** - XHR upload with progress tracking:
- Export `ProcessResponse` interface with: success, scene_count, video_url, suggested_cuts, video_duration, redirect_url
- Export `UploadProgress` interface with: loaded, total, percent
- Export `UploadOptions` interface with: threshold?, minSceneLength?
- Export `uploadVideoWithProgress(file, options, callbacks)` function that:
  - Uses XMLHttpRequest (NOT fetch) for upload progress support
  - Sets `xhr.upload.onprogress` to report progress via callbacks.onProgress
  - Handles onload to parse JSON response, call callbacks.onComplete on success
  - Handles onerror/ontimeout to call callbacks.onError
  - POSTs to `/process` with FormData containing: video file, threshold (default 27), min_scene_length (default 0.6)
  - Sets `xhr.timeout = 0` for large files (no timeout)
  - Returns abort function: `() => xhr.abort()`

**2. frontend/src/stores/uploadStore.ts** - Zustand store for upload state:
- Import ProcessResponse from @/lib/api
- Export type `UploadStatus = 'idle' | 'uploading' | 'processing' | 'complete' | 'error'`
- Store state: file (File | null), status (UploadStatus), progress (number 0-100), error (string | null), result (ProcessResponse | null)
- Actions: setFile, startUpload, updateProgress, setProcessing, setComplete, setError, reset
- Follow existing uiStore.ts pattern with create<State>()((set) => ...)

**3. frontend/src/components/ui/ProgressBar.tsx** - Reusable progress bar:
- Props: value (0-100), label?, showPercent? (default true), className?
- Use cn() for conditional classes
- Structure: outer div (w-full), label row (flex justify-between), track (h-2 bg-gray-800 rounded-full), fill (bg-blue-600 transition-all)
- Add role="progressbar", aria-valuenow, aria-valuemin, aria-valuemax for accessibility
- Clamp value between 0-100
  </action>
  <verify>
Run TypeScript check: `cd frontend && npx tsc --noEmit`
Verify files exist: api.ts, uploadStore.ts, ProgressBar.tsx
Check exports: grep for "export function uploadVideoWithProgress" and "export const useUploadStore"
  </verify>
  <done>
- api.ts exports uploadVideoWithProgress with XHR progress tracking
- uploadStore.ts exports useUploadStore with upload state and actions
- ProgressBar.tsx renders accessible progress bar with value/label props
  </done>
</task>

<task type="auto">
  <name>Task 2: Create DropZone component with react-dropzone</name>
  <files>
    frontend/src/components/upload/DropZone.tsx
  </files>
  <action>
First install react-dropzone: `cd frontend && npm install react-dropzone`

Create **frontend/src/components/upload/DropZone.tsx**:
- Import useDropzone from react-dropzone, useCallback from react
- Import Video, Upload, AlertCircle icons from lucide-react
- Import cn from @/lib/utils

Define constants:
- ACCEPTED_VIDEO_TYPES object mapping MIME types to extensions: video/mp4, video/quicktime (.mov), video/x-msvideo (.avi), video/x-matroska (.mkv), video/x-flv, video/x-ms-wmv
- MAX_FILE_SIZE = 500 * 1024 * 1024 (500MB, matches Flask config)

Props interface:
- onFileSelect: (file: File) => void
- onError: (message: string) => void
- disabled?: boolean

Component implementation:
- useCallback for onDrop handler that checks rejectedFiles, maps error codes to Hebrew messages:
  - file-too-large: "הקובץ גדול מדי. מקסימום 500MB"
  - file-invalid-type: "סוג קובץ לא נתמך. נא להעלות MP4, MOV, AVI או MKV"
- useDropzone with: onDrop, accept: ACCEPTED_VIDEO_TYPES, maxFiles: 1, maxSize: MAX_FILE_SIZE, multiple: false, disabled
- Destructure: getRootProps, getInputProps, isDragActive, isDragReject

Render:
- Outer div with getRootProps() spread, cn() classes for:
  - Base: border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-colors min-h-[200px] flex flex-col items-center justify-center
  - Active drag: border-blue-500 bg-blue-500/10
  - Reject: border-red-500 bg-red-500/10
  - Idle: border-gray-700 hover:border-gray-600
  - Disabled: opacity-50 cursor-not-allowed
  - Focus: focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500
- Hidden input with getInputProps()
- Conditional content based on state:
  - isDragReject: AlertCircle icon + "סוג קובץ לא תקין" (red)
  - isDragActive: Upload icon (animate-bounce) + "שחרר את הקובץ כאן" (blue)
  - Default: Video icon + "גרור ושחרר קובץ וידאו" + "או הקש לבחירה מהמכשיר" + "MP4, MOV, AVI, MKV (עד 500MB)"
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit`
Check react-dropzone installed: grep "react-dropzone" package.json
Verify DropZone exports: grep "export function DropZone" src/components/upload/DropZone.tsx
  </verify>
  <done>
- react-dropzone installed as dependency
- DropZone component accepts video files with drag-drop and click
- Visual states for idle/active/reject/disabled render correctly
- Hebrew labels display throughout
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up UploadPage with complete upload flow</name>
  <files>
    frontend/src/pages/UploadPage.tsx
  </files>
  <action>
Replace UploadPage.tsx with complete upload implementation:

Imports:
- useNavigate from react-router-dom
- useEffect, useRef from react
- useUploadStore from @/stores/uploadStore
- uploadVideoWithProgress from @/lib/api
- DropZone from @/components/upload/DropZone
- ProgressBar from @/components/ui/ProgressBar
- Button from @/components/ui/Button
- Loader2 icon from lucide-react

Component implementation:
1. Get navigate from useNavigate()
2. Destructure from useUploadStore: file, status, progress, error, result, setFile, startUpload, updateProgress, setProcessing, setComplete, setError, reset
3. useRef for abort function: abortRef = useRef<(() => void) | null>(null)

4. useEffect for navigation on complete:
   - When status === 'complete' && result exists
   - Build URL: `/editor?video=${encodeURIComponent(result.video_url)}&cuts=${result.suggested_cuts.join(',')}`
   - Call navigate(url, { replace: true })
   - Dependencies: [status, result, navigate]

5. handleFileSelect callback:
   - Call setFile(file)

6. handleUpload function:
   - Guard: if (!file) return
   - Call startUpload()
   - Call abortRef.current = uploadVideoWithProgress(file, { threshold: 27, minSceneLength: 0.6 }, { onProgress, onComplete, onError })
   - onProgress: if percent < 100 call updateProgress(percent), else call setProcessing()
   - onComplete: call setComplete(response)
   - onError: call setError(error.message)

7. handleCancel function:
   - Call abortRef.current?.()
   - Call reset()

8. Cleanup useEffect:
   - On unmount: abortRef.current?.()
   - Return cleanup function

Render structure:
```
<div className="p-4">
  <h1 className="text-2xl font-bold mb-4 text-right">העלאת סרטון</h1>

  {status === 'idle' && (
    <>
      <DropZone onFileSelect={handleFileSelect} onError={setError} />
      {file && (
        <div className="mt-4 p-4 bg-gray-800/50 rounded-lg">
          <p className="text-gray-300 truncate">{file.name}</p>
          <p className="text-gray-500 text-sm">{(file.size / 1024 / 1024).toFixed(1)} MB</p>
          <div className="mt-4 flex gap-2">
            <Button variant="primary" onClick={handleUpload} className="flex-1">העלה</Button>
            <Button variant="ghost" onClick={reset}>ביטול</Button>
          </div>
        </div>
      )}
    </>
  )}

  {status === 'uploading' && (
    <div className="text-center py-8">
      <ProgressBar value={progress} label="מעלה..." className="mb-4" />
      <Button variant="ghost" onClick={handleCancel}>ביטול</Button>
    </div>
  )}

  {status === 'processing' && (
    <div className="text-center py-8">
      <Loader2 className="w-12 h-12 animate-spin text-blue-500 mx-auto mb-4" />
      <p className="text-gray-300">מזהה סצנות...</p>
      <p className="text-gray-500 text-sm">זה עשוי לקחת כמה שניות</p>
    </div>
  )}

  {status === 'error' && (
    <div className="text-center py-8">
      <p className="text-red-400 mb-4">{error}</p>
      <Button variant="primary" onClick={reset}>נסה שנית</Button>
    </div>
  )}
</div>
```
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit`
Start dev server: `cd frontend && npm run dev` (verify no console errors)
Manual test:
1. Open http://localhost:5173
2. Verify drop zone renders with Hebrew text
3. Drag video file or click to select
4. Verify file info shows after selection
5. Click upload, verify progress bar updates
6. Verify navigation to /editor with query params after processing
  </verify>
  <done>
- UploadPage shows DropZone when idle
- File selection displays file name and size
- Upload shows progress bar with real XHR progress
- Processing shows spinner with "מזהה סצנות..."
- Error state shows message with retry button
- Navigation to /editor?video=...&cuts=... happens on complete
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles without errors: `cd frontend && npx tsc --noEmit`
2. Dev server runs without errors: `cd frontend && npm run dev`
3. Upload flow works end-to-end (requires Flask backend running on port 5000)
4. Progress bar updates during upload
5. Navigation to /editor occurs after processing
</verification>

<success_criteria>
1. User can drag-and-drop video onto DropZone - visual feedback on drag
2. User can tap DropZone to open file picker on mobile
3. Progress bar shows real upload progress (not fake)
4. Processing state shows spinner while scene detection runs
5. Automatic redirect to /editor?video=...&cuts=... after processing
6. Error handling shows message and retry option
7. Cancel button aborts upload and resets state
</success_criteria>

<output>
After completion, create `.planning/phases/02-upload-feature/02-01-SUMMARY.md` using the summary template.
</output>
