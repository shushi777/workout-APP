---
phase: 03-timeline-editor
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/timeline/DraggableCutPoint.tsx
  - frontend/src/hooks/useVideoSegmentPlayback.ts
  - frontend/src/components/timeline/VideoPlayer.tsx
  - frontend/src/components/tagging/SegmentDrawer.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Cut point shows as single circle when dragging (no duplicate)"
    - "Clicking video player toggles play/pause correctly"
    - "Main player does not auto-play when clicking segment card"
    - "Drawer video seekbar shows segment length, not full video length"
  artifacts:
    - path: "frontend/src/components/timeline/DraggableCutPoint.tsx"
      provides: "Invisible visual indicator (touch target only)"
      contains: "opacity-0"
    - path: "frontend/src/hooks/useVideoSegmentPlayback.ts"
      provides: "Segment playback with autoPlay parameter"
      exports: ["useVideoSegmentPlayback"]
    - path: "frontend/src/components/timeline/VideoPlayer.tsx"
      provides: "Main player without auto-play on segment select"
      contains: "autoPlay: false"
    - path: "frontend/src/components/tagging/SegmentDrawer.tsx"
      provides: "Custom seekbar showing segment-relative time"
      contains: "segment.end - segment.start"
  key_links:
    - from: "VideoPlayer.tsx"
      to: "useVideoSegmentPlayback"
      via: "hook with autoPlay: false"
      pattern: "autoPlay.*false"
---

<objective>
Fix 4 UAT gaps in the Timeline Editor phase related to cut point rendering, video player behavior, and drawer seekbar.

Purpose: Close user-reported issues from UAT testing to complete Phase 3 quality requirements.
Output: Working timeline editor without duplicate cut points, correct play/pause behavior, and accurate drawer seekbar.
</objective>

<execution_context>
@C:\Users\OmriS\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\OmriS\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-timeline-editor/03-UAT.md

# Source files to modify
@frontend/src/components/timeline/DraggableCutPoint.tsx
@frontend/src/hooks/useVideoSegmentPlayback.ts
@frontend/src/components/timeline/VideoPlayer.tsx
@frontend/src/components/tagging/SegmentDrawer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Make DraggableCutPoint invisible (fix duplicate circles)</name>
  <files>frontend/src/components/timeline/DraggableCutPoint.tsx</files>
  <action>
The Canvas draws cut point circles via drawCutPoints() in useCanvasTimeline.ts (lines 234-243).
The DraggableCutPoint component ALSO renders a visible 16x16px circle (lines 44-55), creating duplicate visual.

Fix: Make the inner circle invisible while keeping the 44x44px touch target.

In DraggableCutPoint.tsx, change the inner div (lines 44-55) to be invisible:
- Add `opacity-0` class to the inner circle div
- Keep all other classes (positioning, size) for potential future use
- The 44x44px parent div remains the invisible touch/drag target

The result:
- Canvas draws the ONLY visible circle
- DraggableCutPoint provides invisible 44x44px drag handle
- No visual duplication
  </action>
  <verify>
Run `npm run dev` in frontend folder.
Load editor with a video that has cut points.
Visually confirm each cut point shows as SINGLE circle (not double).
Drag a cut point - should move smoothly with single circle visible.
  </verify>
  <done>Cut points render as single circles on Canvas with no visible duplicate from React overlay.</done>
</task>

<task type="auto">
  <name>Task 2: Fix video player play/pause and remove main player auto-play</name>
  <files>frontend/src/hooks/useVideoSegmentPlayback.ts, frontend/src/components/timeline/VideoPlayer.tsx</files>
  <action>
Two related issues:
1. Clicking pause doesn't work - hook calls video.play() when segment is selected, overriding user pause
2. Main player auto-plays when clicking segment card - hook designed for drawer, not main player

Fix both by adding autoPlay parameter to useVideoSegmentPlayback:

In useVideoSegmentPlayback.ts:
- Add `autoPlay: boolean = true` parameter to hook signature
- Only call `video.play()` if autoPlay is true
- Keep the timeupdate listener (segment boundary enforcement) regardless of autoPlay

New signature:
```typescript
export function useVideoSegmentPlayback(
  videoRef: React.RefObject<HTMLVideoElement | null>,
  segment: Segment | null,
  isActive: boolean,
  autoPlay: boolean = true
)
```

In the useEffect (lines 27-30), wrap the play call:
```typescript
if (autoPlay) {
  video.play().catch((err) => {
    console.log('[useVideoSegmentPlayback] Auto-play prevented:', err);
  });
}
```

In VideoPlayer.tsx:
- Pass `autoPlay: false` as fourth argument to useVideoSegmentPlayback (line 37)
- This prevents auto-play on segment select in main player
- User can still manually play/pause via click
- Segment boundary enforcement still works (pauses at segment end)

Result:
- Main player: User clicks to play, clicks to pause (works correctly)
- Main player: Selecting segment does NOT auto-play
- Drawer preview: Still auto-plays (uses default autoPlay: true via native autoPlay attribute)
  </action>
  <verify>
1. Click segment card - main player should NOT start playing
2. Click main player video area - should start playing
3. Click main player again while playing - should pause
4. Let segment play to end - should pause at segment boundary
5. Open drawer - drawer preview should auto-play segment
  </verify>
  <done>Main player respects user play/pause clicks. Segment selection does not auto-play main player. Drawer preview still auto-plays.</done>
</task>

<task type="auto">
  <name>Task 3: Replace drawer native controls with custom segment-relative seekbar</name>
  <files>frontend/src/components/tagging/SegmentDrawer.tsx</files>
  <action>
The drawer video uses native HTML5 `controls` attribute which shows full video duration in the seekbar, not segment duration.

Fix: Replace native controls with custom seekbar that shows segment-relative time.

In SegmentDrawer.tsx:

1. Add video ref and state at component top:
```typescript
const drawerVideoRef = useRef<HTMLVideoElement>(null);
const [drawerTime, setDrawerTime] = useState(0);
const [isDrawerPlaying, setIsDrawerPlaying] = useState(false);
```

2. Add useEffect to sync video time and handle timeupdate:
```typescript
useEffect(() => {
  const video = drawerVideoRef.current;
  if (!video || !segment) return;

  const handleTimeUpdate = () => {
    setDrawerTime(video.currentTime);
    // Stop at segment end
    if (video.currentTime >= segment.end - 0.1) {
      video.pause();
      video.currentTime = segment.start;
    }
  };

  const handlePlay = () => setIsDrawerPlaying(true);
  const handlePause = () => setIsDrawerPlaying(false);

  video.addEventListener('timeupdate', handleTimeUpdate);
  video.addEventListener('play', handlePlay);
  video.addEventListener('pause', handlePause);

  return () => {
    video.removeEventListener('timeupdate', handleTimeUpdate);
    video.removeEventListener('play', handlePlay);
    video.removeEventListener('pause', handlePause);
  };
}, [segment]);
```

3. Replace the video element (lines 113-121):
- Remove `controls` attribute
- Add `ref={drawerVideoRef}`
- Keep `autoPlay` and `muted`
- Add click handler for play/pause toggle

4. Add custom controls below video:
```tsx
{/* Custom Controls */}
{segment && (
  <div className="bg-black/80 p-2 flex items-center gap-2">
    <button
      onClick={() => {
        const video = drawerVideoRef.current;
        if (video) {
          isDrawerPlaying ? video.pause() : video.play();
        }
      }}
      className="w-8 h-8 flex items-center justify-center text-white"
    >
      {isDrawerPlaying ? <Pause className="w-4 h-4" /> : <Play className="w-4 h-4" />}
    </button>
    <span className="text-white text-xs min-w-[80px]">
      {formatTime(Math.max(0, drawerTime - segment.start))} / {formatTime(segment.end - segment.start)}
    </span>
    <input
      type="range"
      min="0"
      max="100"
      step="0.1"
      value={segment.end > segment.start
        ? ((drawerTime - segment.start) / (segment.end - segment.start)) * 100
        : 0}
      onChange={(e) => {
        const video = drawerVideoRef.current;
        if (video && segment) {
          const progress = parseFloat(e.target.value) / 100;
          video.currentTime = segment.start + progress * (segment.end - segment.start);
        }
      }}
      dir="ltr"
      className="flex-1 h-1.5 bg-white/30 rounded-full appearance-none cursor-pointer
                 [&::-webkit-slider-thumb]:appearance-none [&::-webkit-slider-thumb]:w-3
                 [&::-webkit-slider-thumb]:h-3 [&::-webkit-slider-thumb]:rounded-full
                 [&::-webkit-slider-thumb]:bg-blue-500"
    />
  </div>
)}
```

5. Add Play and Pause imports from lucide-react (add to existing import line 2).

Result:
- Time display shows "00:05 / 00:15" for a 15-second segment at 5 seconds in
- Seekbar fills based on position within segment (not full video)
- Play/pause button for manual control
  </action>
  <verify>
1. Open drawer for any segment
2. Check time display shows segment-relative time (starts at 00:00, max is segment duration)
3. Check seekbar fills from 0-100% within segment duration
4. Drag seekbar - video should seek within segment bounds
5. Click play/pause button - should toggle playback
  </verify>
  <done>Drawer video shows custom controls with segment-relative seekbar displaying segment duration, not full video duration.</done>
</task>

</tasks>

<verification>
All 4 UAT gaps addressed:

1. **Duplicate cut points** - Canvas renders single circle, DraggableCutPoint is invisible touch target
2. **Play/pause not working** - Main player respects user clicks without hook overriding
3. **Main player auto-plays on segment select** - autoPlay parameter prevents this
4. **Drawer seekbar shows full video length** - Custom seekbar shows segment-relative time

Manual testing checklist:
- [ ] Cut points show as single circles (no duplicates)
- [ ] Click main player to play - works
- [ ] Click main player to pause - works
- [ ] Select segment - main player does NOT auto-play
- [ ] Drawer preview auto-plays segment
- [ ] Drawer seekbar shows segment duration (e.g., "00:05 / 00:12")
- [ ] Drawer seekbar seeks within segment bounds
</verification>

<success_criteria>
- All 4 UAT gaps pass re-testing
- No visual regression on timeline editor
- Video player controls work as expected on mobile
</success_criteria>

<output>
After completion, create `.planning/phases/03-timeline-editor/03-05-SUMMARY.md`
</output>
