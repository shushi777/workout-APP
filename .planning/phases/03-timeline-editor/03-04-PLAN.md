---
phase: 03-timeline-editor
plan: 04
type: execute
wave: 4
depends_on: ["03-03"]
files_modified:
  - frontend/src/lib/api.ts
  - frontend/src/components/timeline/SaveFlow.tsx
  - frontend/src/pages/EditorPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can save all tagged segments"
    - "User sees progress indicator during video cutting"
    - "User is navigated to Library after successful save"
  artifacts:
    - path: "frontend/src/lib/api.ts"
      provides: "saveTimeline API function"
      exports: ["saveTimeline", "SaveTimelineRequest", "SaveTimelineResponse"]
    - path: "frontend/src/components/timeline/SaveFlow.tsx"
      provides: "Save button with progress modal"
      min_lines: 80
  key_links:
    - from: "frontend/src/components/timeline/SaveFlow.tsx"
      to: "/api/timeline/save"
      via: "fetch POST request"
      pattern: "fetch.*api/timeline/save"
    - from: "frontend/src/pages/EditorPage.tsx"
      to: "react-router-dom"
      via: "useNavigate to /library"
      pattern: "navigate.*library"
---

<objective>
Create the save flow with progress indicator and navigation to Library.

Purpose: After tagging segments, users need to save their work. The backend cuts the video into segments and stores them. Users need feedback during this potentially long operation, then navigation to see their saved exercises.

Output: SaveFlow component with progress modal, saveTimeline API function, and navigation to Library after success.
</objective>

<execution_context>
@C:\Users\OmriS\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\OmriS\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-timeline-editor/03-RESEARCH.md
@.planning/phases/03-timeline-editor/03-01-SUMMARY.md
@.planning/phases/03-timeline-editor/03-02-SUMMARY.md
@.planning/phases/03-timeline-editor/03-03-SUMMARY.md

Backend endpoint (from CLAUDE.md):
POST /api/timeline/save
Request body:
{
  "videoUrl": "/download/video_name_timestamp/video_name.mp4",
  "cutPoints": [...],
  "segments": [
    {
      "start": 0,
      "end": 15.5,
      "details": {
        "name": "Push-ups",
        "muscleGroups": ["chest", "triceps"],
        "equipment": ["bodyweight"],
        "removeAudio": false
      }
    }
  ]
}
Response:
{
  "success": true,
  "saved_count": 2,
  "message": "Saved 2 exercises to database"
}
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add saveTimeline API function</name>
  <files>
    frontend/src/lib/api.ts
  </files>
  <action>
Add saveTimeline function to api.ts:

```typescript
// Add to existing interfaces
export interface SegmentDetails {
  name: string;
  muscleGroups: string[];
  equipment: string[];
  removeAudio: boolean;
}

export interface SaveTimelineSegment {
  start: number;
  end: number;
  details: SegmentDetails;
}

export interface SaveTimelineRequest {
  videoUrl: string;
  cutPoints: Array<{ time: number; type: string; id: string }>;
  segments: SaveTimelineSegment[];
}

export interface SaveTimelineResponse {
  success: boolean;
  saved_count: number;
  message: string;
}

export async function saveTimeline(data: SaveTimelineRequest): Promise<SaveTimelineResponse> {
  const response = await fetch('/api/timeline/save', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(data),
  });

  if (!response.ok) {
    const errorText = await response.text();
    throw new Error(`Failed to save timeline: ${errorText}`);
  }

  return response.json();
}
```

Also add getTags if not already added in 03-01:
```typescript
export interface TagsResponse {
  muscle_groups: string[];
  equipment: string[];
}

export async function getTags(): Promise<TagsResponse> {
  const response = await fetch('/get-tags');
  if (!response.ok) {
    throw new Error('Failed to fetch tags');
  }
  return response.json();
}
```
  </action>
  <verify>
    - `npm run build` passes
    - api.ts exports saveTimeline and all related types
  </verify>
  <done>saveTimeline API function with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Create SaveFlow component with progress modal</name>
  <files>
    frontend/src/components/timeline/SaveFlow.tsx
  </files>
  <action>
Create SaveFlow.tsx component:

```tsx
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Save, Loader2, CheckCircle, AlertCircle } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { useTimelineStore } from '@/stores/timelineStore';
import { saveTimeline } from '@/lib/api';
import { cn } from '@/lib/utils';

type SaveStatus = 'idle' | 'confirming' | 'saving' | 'success' | 'error';

export function SaveFlow() {
  const navigate = useNavigate();
  const [status, setStatus] = useState<SaveStatus>('idle');
  const [error, setError] = useState<string | null>(null);
  const [savedCount, setSavedCount] = useState(0);

  const { videoUrl, cutPoints, segments } = useTimelineStore();

  // Get segments with details
  const segmentsWithDetails = segments.filter(seg => seg.details !== null);
  const canSave = segmentsWithDetails.length > 0;

  const handleSaveClick = () => {
    if (!canSave) return;
    setStatus('confirming');
  };

  const handleConfirm = async () => {
    if (!videoUrl) return;

    setStatus('saving');
    setError(null);

    try {
      // Prepare data for backend
      const data = {
        videoUrl,
        cutPoints,
        segments: segmentsWithDetails.map(seg => ({
          start: seg.start,
          end: seg.end,
          details: seg.details!,
        })),
      };

      const result = await saveTimeline(data);

      if (result.success) {
        setSavedCount(result.saved_count);
        setStatus('success');

        // Navigate to library after 2 seconds
        setTimeout(() => {
          navigate('/library');
        }, 2000);
      } else {
        throw new Error(result.message || 'Unknown error');
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to save');
      setStatus('error');
    }
  };

  const handleCancel = () => {
    setStatus('idle');
    setError(null);
  };

  const handleRetry = () => {
    setStatus('confirming');
    setError(null);
  };

  return (
    <>
      {/* Save Button */}
      <Button
        onClick={handleSaveClick}
        disabled={!canSave}
        className="flex items-center gap-2"
      >
        <Save className="w-4 h-4" />
        שמור ({segmentsWithDetails.length})
      </Button>

      {/* Modal Overlay */}
      {status !== 'idle' && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-gray-900 rounded-xl p-6 max-w-sm w-full space-y-4 text-center">
            {/* Confirming State */}
            {status === 'confirming' && (
              <>
                <h3 className="text-xl font-bold text-white">שמירת תרגילים</h3>
                <p className="text-gray-300">
                  האם לשמור {segmentsWithDetails.length} תרגילים למאגר?
                </p>
                <p className="text-sm text-gray-500">
                  הפעולה תחתוך את הוידאו לקטעים נפרדים
                </p>
                <div className="flex gap-3 pt-2">
                  <Button onClick={handleConfirm} className="flex-1">
                    שמור
                  </Button>
                  <Button onClick={handleCancel} variant="secondary" className="flex-1">
                    ביטול
                  </Button>
                </div>
              </>
            )}

            {/* Saving State */}
            {status === 'saving' && (
              <>
                <Loader2 className="w-12 h-12 text-blue-500 mx-auto animate-spin" />
                <h3 className="text-xl font-bold text-white">שומר תרגילים...</h3>
                <p className="text-gray-400">
                  מעבד ושומר את קטעי הוידאו
                </p>
                <p className="text-sm text-gray-500">
                  פעולה זו עשויה לקחת מספר דקות
                </p>
              </>
            )}

            {/* Success State */}
            {status === 'success' && (
              <>
                <CheckCircle className="w-12 h-12 text-green-500 mx-auto" />
                <h3 className="text-xl font-bold text-white">נשמר בהצלחה!</h3>
                <p className="text-gray-300">
                  {savedCount} תרגילים נשמרו למאגר
                </p>
                <p className="text-sm text-gray-500">
                  מעביר לספריית התרגילים...
                </p>
              </>
            )}

            {/* Error State */}
            {status === 'error' && (
              <>
                <AlertCircle className="w-12 h-12 text-red-500 mx-auto" />
                <h3 className="text-xl font-bold text-white">שגיאה בשמירה</h3>
                <p className="text-gray-300">{error}</p>
                <div className="flex gap-3 pt-2">
                  <Button onClick={handleRetry} className="flex-1">
                    נסה שוב
                  </Button>
                  <Button onClick={handleCancel} variant="secondary" className="flex-1">
                    סגור
                  </Button>
                </div>
              </>
            )}
          </div>
        </div>
      )}
    </>
  );
}
```

Key implementation details:
- Button disabled when no segments have details
- Shows count of tagged segments in button
- Confirmation dialog before saving
- Loading spinner during save
- Success message with auto-navigate after 2 seconds
- Error handling with retry option
- Modal is centered with dark overlay
  </action>
  <verify>
    - `npm run build` passes
    - SaveFlow shows disabled button when no segments tagged
    - SaveFlow shows enabled button with count when segments tagged
  </verify>
  <done>SaveFlow component with confirmation, progress, and navigation</done>
</task>

<task type="auto">
  <name>Task 3: Wire SaveFlow to EditorPage header</name>
  <files>
    frontend/src/pages/EditorPage.tsx
  </files>
  <action>
1. Update EditorPage.tsx to include SaveFlow in header:

```tsx
import { SaveFlow } from '@/components/timeline/SaveFlow';

// In the header section, replace or add next to "Add Cut" button:
<div className="flex items-center justify-between">
  <h1 className="text-xl font-bold">עורך טיימליין</h1>
  <div className="flex gap-2">
    <Button onClick={handleAddCutPoint} variant="secondary" size="sm">
      <Scissors className="w-4 h-4 ml-1" />
      הוסף חיתוך
    </Button>
    <SaveFlow />
  </div>
</div>
```

2. Add status indicator showing tagged vs total segments:

```tsx
// Below the header or above segment cards:
<div className="text-sm text-gray-400 text-right">
  <span>{segments.filter(s => s.details).length}</span>
  <span> / </span>
  <span>{segments.length}</span>
  <span className="mr-1">סגמנטים מתויגים</span>
</div>
```

3. Ensure the page has proper padding at bottom for fixed elements:
   - The bottom nav is already accounted for with pb-[72px] in App.tsx
   - Verify SegmentDrawer doesn't overlap with bottom nav

4. Add empty state when no video loaded:

```tsx
if (!videoUrl) {
  return (
    <div className="flex flex-col items-center justify-center h-full p-8 text-center">
      <p className="text-gray-400 text-lg mb-4">
        לא נטען וידאו לעריכה
      </p>
      <Button onClick={() => navigate('/')}>
        העלה וידאו
      </Button>
    </div>
  );
}
```
  </action>
  <verify>
    - `npm run build` passes
    - Save button appears in editor header
    - Save button shows count of tagged segments
    - Click save -> confirmation modal appears
    - After confirm and success -> navigates to /library
  </verify>
  <done>EditorPage with complete save flow and navigation</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build verification:
   ```bash
   cd frontend && npm run build
   ```
   Expected: Build succeeds with no errors

2. Complete flow test:
   a. Upload a video on Upload page
   b. Wait for scene detection, auto-navigate to Editor
   c. See timeline with cut points
   d. Click segment card -> drawer opens
   e. Fill in exercise details, save
   f. See checkmark on segment card
   g. Tag at least one more segment
   h. Click "Save (2)" button in header
   i. Confirm dialog appears -> click "Save"
   j. Loading spinner shows "Saving exercises..."
   k. Success message shows "2 exercises saved"
   l. Auto-navigates to /library after 2 seconds

3. Error handling test:
   - Disconnect network
   - Try to save
   - Error modal should appear
   - Click "Retry" -> tries again
   - Click "Close" -> returns to idle state

4. Edge cases:
   - Save button disabled when no segments tagged
   - Can tag, untag, retag segments before saving
   - Tagged segment count updates in button
</verification>

<success_criteria>
- Save button in header shows tagged segment count
- Save button disabled when no segments have details
- Confirmation dialog before saving
- Loading spinner with message during save
- Success message with auto-navigation to Library
- Error handling with retry option
- Navigation to /library after successful save
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-timeline-editor/03-04-SUMMARY.md`
</output>
